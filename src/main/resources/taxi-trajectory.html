<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出租车轨迹地图</title>
    <style>
        /* 样式定义 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #container {
            width: 100%;
            height: 70%;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        input[type="text"], input[type="datetime-local"], input[type="number"] {
            padding: 8px;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        button {
            padding: 8px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: red;
            border-radius: 50%;
            pointer-events: none;
        }

        .search-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .search-section h3 {
            margin-top: 0;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 5px;
        }

        .form-row label {
            margin-right: 5px;
            min-width: 100px;
        }
    </style>
    <!-- 引入百度地图API -->
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=1.0&&type=webgl&ak=TjH2DBugCdwnk9PDVFl4B0wF0CC0v47N"></script>
</head>
<body>
<h1>出租车数据分析系统</h1>

<!-- F1: 出租车轨迹查询 -->
<div class="search-section">
    <h3>F1: 出租车轨迹查询</h3>
    <div class="form-row">
        <label for="taxiId">出租车ID:</label>
        <input type="text" id="taxiId" placeholder="请输入出租车ID">
        <button onclick="fetchTaxiTrajectory()">查询轨迹</button>
    </div>
</div>

<!-- F3: 区域范围查找 -->
<div class="search-section">
    <h3>F3: 区域范围查找</h3>
    <div class="form-row">
        <label>时间段:</label>
        <input type="datetime-local" id="startTime">
        <span>至</span>
        <input type="datetime-local" id="endTime">
    </div>
    <div class="form-row">
        <label>左上角坐标:</label>
        <input type="text" id="topLeftLng" placeholder="经度">
        <input type="text" id="topLeftLat" placeholder="纬度">
    </div>
    <div class="form-row">
        <label>右下角坐标:</label>
        <input type="text" id="bottomRightLng" placeholder="经度">
        <input type="text" id="bottomRightLat" placeholder="纬度">
    </div>
    <button>区域查找</button>
</div>

<!-- F4: 区域车流密度分析 -->
<div class="search-section">
    <h3>F4: 区域车流密度分析</h3>
    <div class="form-row">
        <label>时间段:</label>
        <input type="datetime-local" id="densityStartTime">
        <span>至</span>
        <input type="datetime-local" id="densityEndTime">
    </div>
    <div class="form-row">
        <label>左上角坐标:</label>
        <input type="text" id="densityTopLeftLng" placeholder="经度">
        <input type="text" id="densityTopLeftLat" placeholder="纬度">
    </div>
    <div class="form-row">
        <label>右下角坐标:</label>
        <input type="text" id="densityBottomRightLng" placeholder="经度">
        <input type="text" id="densityBottomRightLat" placeholder="纬度">
    </div>
    <div class="form-row">
        <label>网格半径(r):</label>
        <input type="number" id="gridRadius" placeholder="网格半径" value="0.001">
    </div>
    <button>密度分析</button>
</div>

<div id="result"></div>
<div id="container"></div>

<script>
    // 全局变量
    var map;
    var overlays = [];

    // 自定义覆盖物类
    function CustomOverlay(point, color = 'red'){
        this._point = point;
        this._color = color;
    }

    CustomOverlay.prototype = new BMapGL.Overlay();

    CustomOverlay.prototype.initialize = function(map){
        this._map = map;
        var div = document.createElement("div");
        div.className = "dot";
        div.style.position = "absolute";
        div.style.backgroundColor = this._color;
        map.getPanes().labelPane.appendChild(div);
        this._div = div;
        return div;
    };

    CustomOverlay.prototype.draw = function(){
        var position = this._map.pointToOverlayPixel(this._point);
        this._div.style.left = position.x - 4 + "px";
        this._div.style.top = position.y - 4 + "px";
    };

    CustomOverlay.prototype.setSize = function(size){
        this._div.style.width = size + "px";
        this._div.style.height = size + "px";
        this.draw();
    };

    // 初始化地图
    function initMap() {
        map = new BMapGL.Map("container");
        var centerPoint = new BMapGL.Point(116.404, 39.915);
        map.centerAndZoom(centerPoint, 11);
        map.enableScrollWheelZoom(true);

        map.addControl(new BMapGL.ScaleControl());
        map.addControl(new BMapGL.ZoomControl());
        map.addControl(new BMapGL.NavigationControl());

        // F2: 地图缩放功能
        // 监听地图缩放事件，当地图缩放时调整轨迹点的大小
        map.addEventListener("zoomend", function () {
            adjustDotsSize(map.getZoom());
        });
    }

    /**
     * F2: 地图缩放功能
     * 根据地图缩放级别调整轨迹点的大小，实现缩放时轨迹的自适应展示
     * 当地图放大时，点变小；当地图缩小时，点变大，保证在不同缩放级别下的可见性
     * @param {number} zoomLevel - 地图当前的缩放级别
     */
    function adjustDotsSize(zoomLevel) {
        var size = Math.max(4, 12 - zoomLevel); // 根据缩放级别动态计算点的大小
        for (var i = 0; i < overlays.length; i++) {
            if (overlays[i].setSize) {
                overlays[i].setSize(size);
            }
        }
    }

    // 坐标转换
    function convertCoordinates(points, callback) {
        if (!points || points.length === 0) {
            callback({ status: -1, points: [] });
            return;
        }

        var convertor = new BMapGL.Convertor();
        var batchPoints = [];
        var results = [];

        for (let i = 0; i < points.length; i += 10) {
            batchPoints.push(points.slice(i, Math.min(i + 10, points.length)));
        }

        function processBatch(index) {
            if (index >= batchPoints.length) {
                callback({ status: 0, points: results });
                return;
            }

            convertor.translate(batchPoints[index], 3, 5, function(data) {
                if (data.status === 0) {
                    results = results.concat(data.points);
                } else {
                    results = results.concat(batchPoints[index]);
                }

                processBatch(index + 1);
            });
        }

        processBatch(0);
    }

    // 清除覆盖物
    function clearOverlays() {
        for (var i = 0; i < overlays.length; i++) {
            map.removeOverlay(overlays[i]);
        }
        overlays = [];
    }

    // 添加点到地图
    function addDotToMap(point, color = 'red') {
        var dotOverlay = new CustomOverlay(point, color);
        map.addOverlay(dotOverlay);
        overlays.push(dotOverlay);
    }

    /**
     * F1: 出租车轨迹查询
     * 根据出租车ID获取轨迹数据，并在地图上显示
     */
    function fetchTaxiTrajectory() {
        var taxiId = document.getElementById('taxiId').value;
        if (taxiId === '') {
            alert('请输入出租车ID');
            return;
        }

        var resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '<p>正在加载数据...</p>';

        clearOverlays();

        var url = `http://localhost:8080/taxi/${taxiId}`;
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('网络响应异常');
                return response.json();
            })
            .then(data => {
                resultDiv.innerHTML = `<p>成功获取出租车 ${taxiId} 的轨迹数据，共 ${data.length} 个点</p>`;

                var points = [];
                data.forEach(record => {
                    points.push(new BMapGL.Point(record.longitude, record.latitude));
                });

                convertCoordinates(points, function(data) {
                    if (data.status === 0) {
                        data.points.forEach(point => {
                            addDotToMap(point);
                        });

                        if (data.points.length > 0) {
                            map.setCenter(data.points[0]);
                        }
                    }
                });
            })
            .catch(error => {
                resultDiv.innerHTML = `<p>查询出错：${error.message}</p>`;
                clearOverlays();
            });
    }

    // 页面加载完成后初始化地图
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        console.log('出租车数据分析系统已初始化');
    });
</script>
</body>
</html>

